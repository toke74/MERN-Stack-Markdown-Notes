# ðŸ§¾ Multi-Vendor eCommerce Backend Requirements (User, Vendor, Order, Product, Payment)

## 1. User Registration Requirements

1. Get user input from `req.body` (name, email, password).
2. Check if a user with the given email already exists in the database.
3. If user exists, throw a 400 error: "User already exists with this email."
4. If user does not exist:
   - Hash the password.
   - Create new user in MongoDB.
5. Generate email verification code/token.
6. Send activation email to user's email with verification link or code.
7. Return status 201 with a message: "User registered successfully. Please verify your email."

```js
//import modules
import jwt from "jsonwebtoken";
import crypto from "crypto";

//import local files
import User from "../models/UserModel.js";
import ErrorHandler from "../utils/errorHandler.js";
import tryCatchAsyncErrorHandlers from "../middleware/tryCatchAsyncErrorHandlers.js";

// @desc    Register user
// @route   POST /api/v1/user/register
// @access  Public
export const registerUser = tryCatchAsyncErrorHandlers(
  async (req, res, next) => {
    // 1. Get user input from req.body (name, email, password).
    const { name, email, password } = req.body;

    //2. Check if a user with the given email already exists in the database.
    const isUserExist = await User.findOne({ email });

    //3. If user exists, throw a 400 error: "User already exists with this email."
    if (isUserExist) {
      return next(
        new ErrorHandler("User already exists with this email.", 400)
      );
    }

    //4. If user does not exist:- Create new user in MongoDB.
    const user = await User.create({
      name,
      email,
      password,
      provider: "Local",
    });

    //5. Generate email verification code/token.

    //6. Send activation email to user's email with verification link or code.

    //7. Return status 201 with a message: "User registered successfully. Please verify your email."
  }
);
```

## 1.1. To send OTP to user email, Generate 4 digit OTP and activation token

1. In utils folder create generateTokens.js file
2. import jwt and "dotenv/config.js to the file
3. create Activation Token arrow function
4. In side the arrow function Generate random 4 digit number as activation code
5. Sign the Activation Code with jwt
6. return the the signed token and activation code

```js
import jwt from "jsonwebtoken";
import "dotenv/config.js";

//create Activation Token
export const createEmailActivationToken = (id) => {
  //Generate random 4 digit number
  const EmailActivationCode = Math.floor(
    1000 + Math.random() * 9000
  ).toString();

  //Sign the Activation Code with jwt
  const EmailActivatioinToken = jwt.sign(
    {
      id,
      EmailActivationCode,
    },
    process.env.JWT_EMAIL_ACTIVATION_SECRET,
    {
      expiresIn: process.env.JWT_EMAIL_ACTIVATION_EXPIRES,
    }
  );

  return { EmailActivationCode, EmailActivatioinToken };
};
```

## 1.2. Create email format to send OTP

1. In mails folder create header.ejs file inside it create header welcome text by using html and css

```html
<div
  style="
    background: linear-gradient(90deg, #1a2e66, #7f00ff);
    padding: 30px 0;
    text-align: center;
    font-family: 'Poppins', Arial, sans-serif;
    color: white;
  "
>
  <img
    src="https://yourdomain.com/path-to-your-logo.png"
    alt="ShopOrbit Logo"
    style="height: 60px; margin-bottom: 10px"
  />
  <h1 style="margin: 0; font-size: 28px">
    Welcome to <span style="color: #f37022">ShopOrbit</span>
  </h1>
  <p style="margin: 5px 0 0; font-size: 16px">Every product delivered to you</p>
</div>
```

2. In mails folder create footer.ejs file inside it create a footer element by using html and css

```html
<div
  style="
    background: linear-gradient(90deg, #1a2e66, #7f00ff);
    padding: 30px 0;
    text-align: center;
    font-family: 'Poppins', Arial, sans-serif;
    color: #ffffff;
    font-size: 14px;
  "
>
  <p style="margin: 0 0 8px">Have questions? We're here to help!</p>
  <p style="margin: 0">
    Contact us at
    <a
      href="mailto:support@shoporbit.com"
      style="color: #f37022; text-decoration: none"
    >
      support@shoporbit.com
    </a>
  </p>
</div>
```

3. In mails folder create welcome.ejs file inside it combine the two the above files and body elements

```html
<%- include('./header.ejs') %>

<div
  style="
    margin: 0 auto;
    max-width: 720px;
    padding: 30px 0;
    font-family: 'Poppins', Arial, sans-serif;
    color: #1c1c1e;
  "
>
  <p style="font-size: 16px">Hello <%= name %>,</p>

  <p style="font-size: 16px; line-height: 1.6">
    Welcome to <strong>ShopOrbit</strong>! Thank you for registering. To
    activate your account, please use the following activation code:
  </p>

  <h2
    style="
      font-size: 28px;
      color: #f37022;
      background-color: #f8f8f8;
      padding: 12px 24px;
      border-radius: 8px;
      text-align: center;
      width: fit-content;
      margin: 20px auto;
    "
  >
    <%= message %>
  </h2>

  <p style="font-size: 16px; line-height: 1.6; text-align: center">
    Please enter this code on the activation page within the next 10 minutes.
  </p>

  <p
    style="
      font-size: 14px;
      color: #666666;
      line-height: 1.6;
      text-align: center;
    "
  >
    If you did not register for a ShopOrbit account, you can safely ignore this
    email.
  </p>
</div>

<%- include('./footer.ejs') %>
```

## 1.3 Using Google App Passwords for Nodemailer

If you're using Google with third-party apps like Nodemailer, direct login with your email password may fail due to enhanced security policies. Instead, generate an App Password.

### To generate an App Password on Google Account:

1. Go to Manage Your Google Account ![Manage Your Google Account](/Images//Manage%20Your%20Google%20acount.png)
2. Then Go to Google Account Settings.
3. Under "Security section" enable 2-Step Verification.
4. After enabling 2-Step Verification, return to the Security section in your Google account.
5. Look for App Passwords option under Security section, if not found there, search it as App Passwords in Search bar in Google account
6. If promoted to Sign in to your account again to verify your identity, go head verify yourself.
7. Type your project name in App name field and click on create.
8. Copy the generated 16-character password. This is your App Password.
9. Use the generated app password in your .env file for Nodemailer.

## 2. User Login Requirements

1. Get email and password from `req.body`.
2. Validate both fields are provided.
3. Find user by email, and include password in query (`select: +password`).
4. If user not found or password doesn't match, return 401: "Invalid credentials".
5. Check if user is banned or not verified.
6. Generate access and refresh JWT tokens.
7. Set refresh token in HttpOnly cookie.
8. Return 200 with access token and user data.

## 3. Refresh Token Requirements

1. Get refresh token from cookies.
2. If missing, return 401: "No refresh token found".
3. Verify token and generate new access token.
4. Return new token and updated user info.

## 4. Logout Requirements

1. Clear refresh token cookie.
2. Return 200 with message: "Logged out successfully".

## 5. Email Verification Requirements

1. Get verification token from request.
2. Find user by token or email.
3. If invalid/expired, return 400.
4. Set `isVerified = true`, clear token.
5. Return 200: "Email verified successfully".

## 6. Forgot Password Requirements

1. Get email from `req.body`.
2. Check if user exists.
3. Generate reset token and expiry.
4. Save to DB and send email with reset link.
5. Return 200 with message.

## 7. Reset Password Requirements

1. Get token and new password from request.
2. Find user by token and validate expiry.
3. Hash new password, update DB.
4. Return 200: "Password updated successfully".

## 8. Get User Profile Requirements

1. Use `req.user.id` to fetch user profile.
2. Return 200 with user data.

## 9. Update Profile Requirements

1. Get updated fields from `req.body`.
2. Update DB, verify if email changed.
3. Return 200 with updated user.

## 10. Change Password Requirements

1. Get old and new password.
2. Verify old password.
3. Hash and update new password.
4. Return 200.

## 11. Wishlist Requirements

1. Get productId.
2. Toggle add/remove from wishlist.
3. Return updated wishlist.

## 12. Address Management Requirements

- **Add/Update/Delete Address**
- Set default
- Return updated address list
